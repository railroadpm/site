<!--
  Render JSON data for individual railroad performance reports, optionally limited to N number of weeks
  (since the most recent week on file)

  Parameters
    railroad            Railroad (Participant) for which to render reports, in the form of a Key string
                        (see Participant.toml)
    avg (optional)      Set to true to include historical averages in rendered reports
    weeks (optional)    Number of weeks to render. If unspecified, all weeks (not marked hidden) are rendered
-->
{{- $data := $.Site.Data -}}
{{- $prpt_key := .Get "railroad" -}}

{{- $weekly_rpt_config := $data.Config.WeeklyReport -}}
{{- $weeks_count_current := $weekly_rpt_config.Displayed.CountOfWeeks.Current -}}
{{- $weeks_count_historical := $weekly_rpt_config.Displayed.CountOfWeeks.Historical -}}

{{- $params := (dict "Prpt" $prpt_key "WeeksCountCurrent" $weeks_count_current "WeeksCountHistorical" $weeks_count_historical) -}}
{{- $prpt := index (where $data.Dimensions.Participant.Railroad "Key" $prpt_key) 0 -}}

{{- $weeks_all := $data.Dimensions.Period.Week -}}
{{- $weeks_visible := sort (where $weeks_all "Hidden" "ne" true) "Key" "asc" -}}
{{- $weeks_historical := last $weeks_count_historical $weeks_visible -}}
{{- $weeks_current := last $weeks_count_current $weeks_visible -}}


{{- $reports := index $data.Measures.BNSF "20180427" -}}
{{- $render_key := "reports_render" -}}
{{- $.Scratch.Set $render_key $reports -}}


{{- $row_map_key := "report_row" -}}
{{- $rows_array_key := "report_rows" -}}

{{- $.Scratch.Delete $row_map_key -}}
{{- $.Scratch.SetInMap $row_map_key "RowLabel" "&nbsp;&nbsp;**Revisions**" -}}
{{- $.Scratch.SetInMap $row_map_key "20180406" "" -}}
{{- $.Scratch.SetInMap $row_map_key "20180413" "" -}}
{{- $.Scratch.SetInMap $row_map_key "20180420" "" -}}
{{- $.Scratch.SetInMap $row_map_key "20180427" "" -}}
{{- $.Scratch.Add $rows_array_key (slice ($.Scratch.Get $row_map_key)) -}}

{{- $.Scratch.Delete $row_map_key -}}
{{- $.Scratch.SetInMap $row_map_key "RowLabel" "System" -}}
{{- $.Scratch.SetInMap $row_map_key "20180406" "64515" -}}
{{- $.Scratch.SetInMap $row_map_key "20180413" "63612" -}}
{{- $.Scratch.SetInMap $row_map_key "20180420" "63500" -}}
{{- $.Scratch.SetInMap $row_map_key "20180427" "62565" -}}
{{- $.Scratch.Add $rows_array_key (slice ($.Scratch.Get $row_map_key)) -}}

{{- $.Scratch.Delete $row_map_key -}}
{{- $.Scratch.SetInMap $row_map_key "RowLabel" "Foreign RR" -}}
{{- $.Scratch.SetInMap $row_map_key "20180406" "23800" -}}
{{- $.Scratch.SetInMap $row_map_key "20180413" "23858" -}}
{{- $.Scratch.SetInMap $row_map_key "20180420" "23822" -}}
{{- $.Scratch.SetInMap $row_map_key "20180427" "23211" -}}
{{- $.Scratch.Add $rows_array_key (slice ($.Scratch.Get $row_map_key)) -}}


{{/*
{{- with .Get "avg" -}}
  {{- $.Scratch.Set $render_key (where $reports TODO) -}}
{{- end -}}
*/}}


  {
    "columns": [
      {{- "\n\t " -}}{{- (dict "key" "RowLabel" "text" "") | jsonify -}}
      {{- "\n\t," -}}{{- delimit (apply (apply $weeks_current "partial" "week-to-label" ".") "chomp" ".") "\n\t," -}}
      {{- "\n    " -}}
    ],

    {{/*
    "rows": {{- $.Scratch.Get $rows_array_key | jsonify }}
    */}}

    "rows": [

      {{- $rpt_rows_params := dict "prpt" $prpt_key "data" $.Site.Data "scratch" $.Scratch "weeks" $weeks_current -}}

      {{- partial "rpt-rows-cars-by-owner-headings" $rpt_rows_params -}}
      {{- partial "rpt-rows-cars-by-owner-measures" $rpt_rows_params -}}

      {{- partial "rpt-rows-cars-by-type-heading" $rpt_rows_params -}}
      {{- partial "rpt-rows-cars-by-type-measures" $rpt_rows_params -}}

      {{- partial "rpt-rows-train-speed-heading" $rpt_rows_params -}}
      {{- partial "rpt-rows-train-speed-measures" $rpt_rows_params -}}

      {{- if ne $prpt_key "AOR" -}}
        {{- partial "rpt-rows-terminal-dwell-heading" $rpt_rows_params -}}
        {{- partial "rpt-rows-terminal-dwell-measures" $rpt_rows_params -}}
      {{- end -}}

      {{- "\n    " -}}
    ]
  }